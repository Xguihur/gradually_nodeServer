## 客户端

1. 自己新建了一个 react 的非常简陋的文件上传，选择图片后点击按钮即可实现上传。
2. 当然，为了测试后端接口，我弄了两个按钮，一个是 get 请求， 一个是 post 请求
3. 在 post 请求中，将获取到的图片使用 formData 进行了包裹！现在比较熟悉 文件上传这一部分了
4. 其中要注意的地方是使用 axios 时要**设置一下 baseUrl**，否则可能会出点问题
5. Post 请求获取到图片相对路径以及URL后，在本地做一下 路径拼接，展示在前端页面中即可

## 服务端

> 这其中的过程我知道每一步想要什么，但具体怎么做我不知道，这里要感谢 ChatGpt 一个一个步骤地帮助我

### 用到的库

* Express
* cors ： 用于解决跨域问题
* multer ： 处理文件上传
* path：具体作用还不清楚，但这是最终保存图片到本地用到的
* fs ： 文件操作模块

### 最终的过程

1. 搭建 node 服务，使用 express 框架
2. 使用 cors 库解决同源策略问题
3. 实现简单 get 请求，并且在客户端调试成功（激动！）

#### Post 请求实现文件上传

1. 首先是普通的 Post 请求测试通过，拿到前端传输的 formData 文件后，不满足于此，于是进一步了解

2. GPT 给的方案是使用 multer 库来辅助实现。

   1. 具体为什么能成功还需要后续完善时进一步学习 multer 库以及 express 的post请求中 upload.single('image')是什么意思。
   2. 以及 storage 的作用是什么，怎么实现生成图片路径的，好酷！！！

3. 在服务器所在的文件夹中能拿到上传成功后的图片后，我便想要进一步完善需求。即前端通过 后端返回的 URL 获取到对应的图片文件！

   1. 这次使用的方式是：express 的静态文件服务 + 图片访问端点 技术
   2. 静态文件服务是怎么实现的我还不清楚，以及为什么要提供这个静态文件服务？它的作用是什么？没有它行不行？
   3. 图片访问端点技术：
      1. 写一个 get 请求，在 URL 中设置 params 参数
      2. 内部通过 patams 获取到后面的 图片名字
      3. 拿到图片名字后，再拼接一下本地文件夹的绝对路径
      4. 最终使用 `res.sendFile` 来实现文件的直接传输
      5. 注意调用 `res.sendFile` 方法时要传第二个参数：`{root:__dirname}` 表示以当前文件夹为根目录

   ## 实际操作

   1. 启动客户端服务、启动服务端服务。:rocket: 如果服务端服务端口有变化要记得修改客户端中的 **baseUrl**
   2. 在客户端中选择图片，点击上传
   3. 此时页面下方会出现 url，选择复制，即可在 浏览器中打开获得图片，也能用于 Image 标签展示图片

   ## 具体代码

   ### 客户端

   ```javascript
   import './App.css'
   import { Button } from 'antd'
   import React, { useState } from 'react'
   import axios from 'axios'
   
   axios.defaults.baseURL = 'http://localhost:3000'
   
   function App() {
     const [selectedFile, setSelectedFile] = useState(null)
   
     const handleFileChange = event => {
       const file = event.target.files[0]
       setSelectedFile(file)
     }
   
     const handleUpload = () => {
       if (!selectedFile) get()
     }
     const handleUploadPost = () => {
       if (!selectedFile) {
         alert('请选择图片资源')
         return
       }
   
       const formData = new FormData()
       formData.append('image', selectedFile)
       post(formData)
     }
   
     const get = () => {
       axios
         .get('/')
         .then(res => {
           console.log(res)
         })
         .catch(e => {
           console.log(e)
         })
     }
     const post = data => {
       // 发送 POST 请求
       axios
         .post('/upload', data, {
           headers: {
             'Content-Type': 'multipart/form-data'
           }
         })
         .then(res => {
           console.log(res)
         })
         .catch(err => {
           console.log(err)
         })
     }
   
     return (
       <div className="App">
         <div className="first-tool">
           <input type="file" onChange={handleFileChange} className="input"></input>
           <div className="btn">
             <Button type="primary" onClick={handleUpload}>
               上传图片 get
             </Button>
             <Button type="primary" onClick={handleUploadPost}>
               上传图片 post
             </Button>
           </div>
           <div className="data">后端返回的数据</div>
         </div>
       </div>
     )
   }
   
   export default App
   
   ```

   ### 服务端

   ```javascript
   const express = require('express')
   const app = express()
   // 解决同源策略问题的库
   const cors = require('cors')
   // 处理文件上传
   const multer = require('multer')
   const path = require('path')
   fs = require('fs')
   
   app.use(cors())  
   // 设置静态文件服务，将图片文件夹映射到 /images 路径
   app.use('/api/images', express.static('uploads'))
   
   // 图片访问端点
   app.get('/images/:imageName', (req, res) => {
     const imageName = req.params.imageName
     // res.send(imageName)
     // 构建图片路径
     const imagePath = `/uploads/${imageName}`
     // 返回图片
     res.sendFile(imagePath, { root: __dirname })
   })
   
   app.get('/', function (req, res) {
     // console.log(req)
     res.send('Hello World!')
   })
   
   let url
   // 配置multer中间件
   const storage = multer.diskStorage({
     destination: function (req, file, cb) {
       cb(null, 'uploads/') // 指定文件保存的目录
     },
     filename: function (req, file, cb) {
       url = file.fieldname + '-' + Date.now() + path.extname(file.originalname)
       cb(null, url) // 生成文件名
     }
   })
   
   const upload = multer({ storage: storage })
   
   // POST路由，接收formData中的图片
   app.post('/upload', upload.single('image'), (req, res) => {
     // 图片已保存到指定目录
     res.send({
       text: `图片已上传并保存成功`,
       url: `/images/${url}`
     })
   })
   
   const server = app.listen(3000, function () {
     // const host = server.address().address
     const host = 'localhost'
     const port = server.address().port
   
     console.log(`Example app listening at http://${host}:${port}`)
   })
   
   ```

   